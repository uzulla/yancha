<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>chat</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<link href="/stylesheets/style.css" rel="stylesheet">
<script src="http://code.jquery.com/jquery-1.6.1.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/moment.min.js"></script>
<script src="/jquery.cookie.js"></script>
<script src="/ios.min.js"></script>

<script>
var socket = io.connect();
var data = {
  token:false,
  nick:false,
  profile_image_url:false,
  tags:{PUBLIC:0}
};
var debug = 0;

//各種接続、切断、エラーイベント
socket.on('connect', function () {
  $('#chat').addClass('connected');
  setPingpong();
});
socket.on('reconnect', function () {
  if(debug){message('System', 'Reconnected to the server');}
  socket.emit('join_tag', data.tags);
});
socket.on('reconnecting', function () {
  if(debug){message('System', 'Attempting to re-connect to the server');}
});
socket.on('error', function (e) {
  if(pingpongTimer != null){
    console.log("disconnected");
    clearTimeout(pingpongTimer);
    pingpongTimer=null;
  }

  if(debug){message('System', e ? e : 'A unknown error occurred');}
});


//サーバからのアナウンス
socket.on('announcement', function (msg) {
  if(debug){
    $('#lines').append($('<p>').append($('<em>').text(msg)));
    $('#lines').get(0).scrollTop = 10000000;  
  }
});

//サーバから、参加ニックネームリストの更新
socket.on('nicknames', function (nicknames) {
  $('#nicknames').empty().append($('<span>Online: </span>'));
  for (var i in nicknames) {
    $('#nicknames').append($('<b>').text(nicknames[i]));
  }
  $(window).resize();
});

//サーバー側にニックネーム登録がない場合に本処理
//messageは再送する為にサーバーから戻されたテキスト、分かりづらく、設計の筋がよくない。
socket.on('no session', function (message) {
  if(data.token){
    console.log('try register');
    socket.emit('token_login', data.token, function (status) {
      if(status && message){ //メッセージを再送する
        socket.emit('user message', message);
      }
    });
  }else{
    alert('ログインしていません、リロードしてログインをやり直してください。');
  }
});


//メッセージイベント
socket.on('user message', function(hash){
  for(var i=0; hash.tags.length > i; i++){
    data.tags[hash.tags[i]] = hash.created_at_ms ;
  }
  
  if(hash.profile_image_url.length>0){
    var img = $('<img style="float:left;margin:3px;">').attr('src', hash.profile_image_url);
  }else{
    var img = $('<img style="float:left;margin:3px;">');
  }
  var from = $('<span style="font-weight:bold;">').text(hash.nickname);
  var text = $('<pre>').append($('<span>').text(hash.text).html().replace(/(http(s)?:\/\/[\x21-\x7e]+)/gi, "<a href='$1' target='_blank'>$1</a>"));
  var time = $('<span style="float:right">').text("("+moment(hash.created_at_ms/100).format('YYYY-MM-DD HH:mm')+")");
    
  $('#lines').append($('<p>').append(img, from, $('<br>'),text, $('<br>'), time, $('<br style="clear:both">')));
  $('#lines').get(0).scrollTop = 10000000;  
});


//ws切断回避用に、暫定的にpingpong(将来的にはpocketIO側の調整で解決予定)
var pingpongTimer = null;
var PINGPONG_WINDOW_MSEC = 10000;
function setPingpong(){
  if(pingpongTimer == null){
    pingpongTimer = setTimeout(function(){
      socket.emit('ping pong', '(」・ω・)」うー');
    }, PINGPONG_WINDOW_MSEC);
  }
}
socket.on('ping pong', function (msg) {
  //console.log('pong!');
  if(msg == 'FAIL'){
    console.log('session not found');
    if(data.token){
      console.log('try create session');
      socket.emit('token_login', data.token);
    }
  }
  pingpongTimer=null;
  setPingpong();
  $(window).resize();

});

//テキスト入力欄をクリア、ただし、タグは残しておく
function clear () {
  var tag_list = ($('#message').val().match(/#[a-zA-Z0-9]+/g, '#')!=null)? $('#message').val().match(/#[a-zA-Z0-9]+/g, '#'): [];
  var str  = tag_list.join(' ');
  $('#message').val(' '+str).focus();
  $('#message')[0].selectionStart = 0;
  $('#message')[0].selectionEnd = 0;
};


//オートログインクッキーを消して、接続を切って、リロード
function logout(){
  $.cookie('yairc_auto_login_token', null);
  $.cookie('chat_tag_list', null);
  data.nick = '';
  data.tags = {'PUBLIC':0};
  socket.emit('disconnect');
  location.href="/";
}

//クッキーがあれば、オートログインさせる
function autologin(){
  if($.cookie('yairc_auto_login_token')){
    data.token = $.cookie('yairc_auto_login_token');
    if(data.token){
      console.log('try autologin');
      socket.emit('token_login', data.token, function (set) {
        clear();
        $('#chat').addClass('nickname-set');
      });
    }
  }
}

//トークンを使ってログインした後、レスポンスされる自分情報を保存
socket.on('token_login', function(res){
  if(res.status == 'ok'){
    var ud = res.user_data;
  
    data.nick = ud.nick;
    data.profile_image_url = ud.profile_image_url;
  
    if( $.cookie('chat_tag_list')){
      var str = $.cookie('chat_tag_list');
      var list = str.split(',');
      for( i in list ){
        data.tags[list[i]] = 0;
      }
    }
    socket.emit('join_tag', data.tags);
  }else{
    alert('自動ログインセッションが不正です、ログインをやり直してください');
    logout();
  }

});

//購読タグを入力させて、サーバーに送信
function setTag(){
    var now_tags = [];    

    for( k in data.tags ){
      now_tags.push(k);
    }
    
    var tag_list_str = prompt('plz set tag.(comma separate, case insesitive)', now_tags.join(',') );

    if(!tag_list_str){
      return false;
    }

    //Textで入力されたタグを配列に
    var tag_list = tag_list_str.toUpperCase().replace(' ','').replace('#','').split(',');
    
    _tags = {};
    _keys = [];
    
    for(var i=0; tag_list.length>i; i++){
      if(typeof(data.tags[tag_list[i]]) == 'undefined'){
        _tags[tag_list[i]] = 0; //未読なので0
      }else{
        _tags[tag_list[i]] = data.tags[tag_list[i]]; //既読の時刻を設定
      }
      _keys.push(tag_list[i]); 
    }
    
    //状態変数に保存しておく
    data.tags = _tags;
    
    //オートログイン用に保存しておく
    $.cookie('chat_tag_list', _keys.join(','), { expires: 1 });
    
    //送信
    socket.emit('join_tag', data.tags);
    return false;
}
//タグ登録処理完了イベント
socket.on('join_tag', function(tags){
  $('#tags').empty().append($('<span>Join Tags: </span>'));
  for (var i in tags) {
    $('#tags').append($('<b>').text(i));
  }
  $(window).resize();

});


//各種初期化
$(function () {

  //送信ボタン
  $('#send-message').submit(function () {
    socket.emit('user message', $('#message').val());
    clear();
    return false;
  });
  
  //インプット欄の改行制御
	$("#send-message").keypress(function(ev) {
		if ((ev.which && ev.which === 13) || (ev.keyCode && ev.keyCode === 13)) {
		  if(ev.shiftKey){
		    return true;
		  }else{
		    $('#send-message').submit();
		    return false;
		  }
		} else {
			return true;
		}
	});  

  //Cookieがあれば、オートログインさせる
  autologin();
  
  $(window).resize(function(){
    $("#nickname").css('height', $(window).height()+'px');
    $("#connecting").css('height', $(window).height()+'px');
  
    var height = $(window).height()- $('#send-message').height();
  
    $("#messages").css('height', height+'px');
    
    height = height - ($('#nicknames').height() + $('#tags').height())
    $("#lines").css('height', height-15+'px');
  });
  
  $(window).resize();

});
</script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-19063513-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>

<body>
<div id="chat">

  <div id="connecting">
    <div class="wrap">Connecting to socket.io server</div>
  </div>

  <div id="nickname">
    <form id="set-nickname" class="wrap">
      <p>Please login by ...</p>
      <p><a href="/login/twitter/start">Twitter</a></p>
    </form>
    <form action="./login" method="post">
      <p>or simple login</p><input type="text" name="nick"><input type="submit" name="login" value="login">
    </form>

  </div>
  
  <div id="messages">
    <div id="nicknames"></div>
    <div id="tags"></div>
    <div id="lines"></div>
  </div>
  
  <form id="send-message">
  <table style="width:100%">
  <tr>
    <td><textarea  id="message"></textarea>
    <td style="width:60px"><button>Send</button>
    <td style="width:60px"><button style="float:right" onclick="setTag()">ChangeTag</button>
    <td style="width:60px"><button style="float:right" onclick="logout()">Logout</button>
  </table>
  </form>
</div>
</body>
</html>
